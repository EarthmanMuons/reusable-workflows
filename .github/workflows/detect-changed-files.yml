name: detect changed files

on:
  workflow_call:
    outputs:
      added_or_modified:
        value: ${{ jobs.filter_changes.outputs.added_or_modified }}
      added_or_modified_files:
        value: ${{ jobs.filter_changes.outputs.added_or_modified_files }}
      flutter:
        value: ${{ jobs.filter_changes.outputs.flutter }}
      flutter_files:
        value: ${{ jobs.filter_changes.outputs.flutter_files }}
      github_actions:
        value: ${{ jobs.filter_changes.outputs.github_actions }}
      github_actions_files:
        value: ${{ jobs.filter_changes.outputs.github_actions_files }}
      markdown:
        value: ${{ jobs.filter_changes.outputs.markdown }}
      markdown_files:
        value: ${{ jobs.filter_changes.outputs.markdown_files }}
      rust:
        value: ${{ jobs.filter_changes.outputs.rust }}
      rust_files:
        value: ${{ jobs.filter_changes.outputs.rust_files }}
      zig:
        value: ${{ jobs.filter_changes.outputs.zig }}
      zig_files:
        value: ${{ jobs.filter_changes.outputs.zig_files }}

jobs:
  filter_changes:
    name: filter changes
    permissions:
      pull-requests: read
    runs-on: ubuntu-latest
    outputs:
      added_or_modified: ${{ steps.filter.outputs.added_or_modified }}
      added_or_modified_files: ${{ steps.filter.outputs.added_or_modified_files }}
      flutter: ${{ steps.filter.outputs.flutter }}
      flutter_files: ${{ steps.filter.outputs.flutter_files }}
      github_actions: ${{ steps.filter.outputs.github_actions }}
      github_actions_files: ${{ steps.filter.outputs.github_actions_files }}
      markdown: ${{ steps.filter.outputs.markdown }}
      markdown_files: ${{ steps.filter.outputs.markdown_files }}
      rust: ${{ steps.filter.outputs.rust }}
      rust_files: ${{ steps.filter.outputs.rust_files }}
      zig: ${{ steps.filter.outputs.zig }}
      zig_files: ${{ steps.filter.outputs.zig_files }}
    steps:
      - name: Checkout source code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
        with:
          fetch-depth: 20
          persist-credentials: false

      - name: Filter changed repository files
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36
        id: filter
        with:
          list-files: shell
          filters: |
            added_or_modified:
              - added|modified: '**'
            flutter:
              - '**/*.dart'
              - '**/pubspec.*'
              - 'analysis_options.yaml'
            github_actions:
              - added|modified: .github/workflows/*.yml
              - added|modified: .github/workflows/*.yaml
            markdown:
              - added|modified: '**/*.md'
            rust:
              - '**/*.rs'
              - '**/Cargo.*'
            zig:
              - '**/*.zig'
              - '**/*.zon'

      - name: Annotate workflow run with changed file categories
        env:
          ADDED_OR_MODIFIED: ${{ steps.filter.outputs.added_or_modified }}
          ADDED_OR_MODIFIED_FILES: ${{ steps.filter.outputs.added_or_modified_files }}
          FLUTTER: ${{ steps.filter.outputs.flutter }}
          FLUTTER_FILES: ${{ steps.filter.outputs.flutter_files }}
          GITHUB_ACTIONS: ${{ steps.filter.outputs.github_actions }}
          GITHUB_ACTIONS_FILES: ${{ steps.filter.outputs.github_actions_files }}
          MARKDOWN: ${{ steps.filter.outputs.markdown }}
          MARKDOWN_FILES: ${{ steps.filter.outputs.markdown_files }}
          RUST: ${{ steps.filter.outputs.rust }}
          RUST_FILES: ${{ steps.filter.outputs.rust_files }}
          ZIG: ${{ steps.filter.outputs.zig }}
          ZIG_FILES: ${{ steps.filter.outputs.zig_files }}
        run: |
          set -euo pipefail

          append_summary() {
            local label="$1"
            local changed="$2"
            local files="$3"
            {
              echo "- ${label}: ${changed}"
              if [[ "${changed}" == "true" && -n "${files}" ]]; then
                printf '%s\n' "${files}" | sed -e 's/^/  - `/' -e 's/$/`/'
              fi
            } >>"$GITHUB_STEP_SUMMARY"
          }

          emit_category() {
            local label="$1"
            local changed="$2"
            local files="$3"
            if [[ "${changed}" == "true" ]]; then
              echo "::notice::${label} changed."
              if [[ -n "${files}" ]]; then
                echo "::group::${label} changed files"
                printf '%s\n' "${files}"
                echo "::endgroup::"
              fi
            fi
            append_summary "${label}" "${changed}" "${files}"
          }

          echo "### :mag: Changed file categories" >>"$GITHUB_STEP_SUMMARY"
          emit_category "Any tracked files" "${ADDED_OR_MODIFIED}" "${ADDED_OR_MODIFIED_FILES}"
          emit_category "Flutter" "${FLUTTER}" "${FLUTTER_FILES}"
          emit_category "GitHub Actions" "${GITHUB_ACTIONS}" "${GITHUB_ACTIONS_FILES}"
          emit_category "Markdown" "${MARKDOWN}" "${MARKDOWN_FILES}"
          emit_category "Rust" "${RUST}" "${RUST_FILES}"
          emit_category "Zig" "${ZIG}" "${ZIG_FILES}"

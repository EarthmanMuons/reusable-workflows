name: pull request

"on":
  pull_request:
    branches:
      - main
  merge_group:
    types:
      - checks_requested

permissions:
  pull-requests: read

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  detect_changed_files:
    name: detect changed files
    uses: ./.github/workflows/detect-changed-files.yml

  github_actions:
    name: github actions
    needs: detect_changed_files
    uses: ./.github/workflows/github-actions.yml

  markdown:
    name: markdown
    needs: detect_changed_files
    uses: ./.github/workflows/markdown.yml

  spelling:
    name: spelling
    needs: detect_changed_files
    uses: ./.github/workflows/spelling.yml

  ready_to_merge:
    name: ready to merge
    needs:
      - detect_changed_files
      - github_actions
      - markdown
      - spelling
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: "Check status of all jobs"
        run: |-
          NEEDS_CONTEXT='${{ toJson(needs) }}'
          JOB_IDS=$(echo "$NEEDS_CONTEXT" | jq -r 'keys[]')
          for JOB_ID in $JOB_IDS; do
            RESULT=$(echo "$NEEDS_CONTEXT" | jq -r ".[\"$JOB_ID\"].result")
            if [[ $RESULT != "success" && $RESULT != "skipped" ]]; then
              echo "***"
              echo "Error: The $JOB_ID job did not pass."
              exit 1
            fi
          done
          echo "All jobs passed or were skipped."
